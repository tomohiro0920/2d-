<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SUPER PLATFORMER</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --accent: #ffd700;
      --danger: #ff3333;
      --hud:    #000000cc;
    }

    body {
      background: #1a1a2e;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      font-family: 'Press Start 2P', monospace;
      user-select: none;
      overflow: hidden;
    }

    /* Google Fonts ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ã */
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

    /* â”€â”€ ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ â”€â”€ */
    #titleScreen {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, #0f0c29, #302b63 50%, #24243e);
      z-index: 100;
      gap: 2rem;
    }

    #titleScreen h1 {
      color: var(--accent);
      font-size: clamp(1.2rem, 4vw, 2.5rem);
      text-align: center;
      text-shadow: 4px 4px 0 #b8860b, 0 0 30px #ffd70088;
      animation: titlePulse 2s ease-in-out infinite;
    }

    @keyframes titlePulse {
      0%, 100% { text-shadow: 4px 4px 0 #b8860b, 0 0 20px #ffd70066; }
      50%       { text-shadow: 4px 4px 0 #b8860b, 0 0 50px #ffd700cc; }
    }

    .controls-hint {
      color: #aaa;
      font-size: 0.55rem;
      line-height: 2.4;
      text-align: center;
    }

    #startBtn {
      background: var(--accent);
      color: #000;
      border: none;
      padding: 1rem 2.5rem;
      font-family: inherit;
      font-size: 0.75rem;
      cursor: pointer;
      clip-path: polygon(6px 0%, 100% 0%, calc(100% - 6px) 100%, 0% 100%);
      animation: blink 1.2s step-end infinite;
      transition: transform 0.1s, filter 0.1s;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50%       { opacity: 0.3; }
    }

    #startBtn:hover  { transform: scale(1.05); filter: brightness(1.2); animation: none; }
    #startBtn:active { transform: scale(0.97); }

    /* â”€â”€ ã‚²ãƒ¼ãƒ ãƒ©ãƒƒãƒ‘ãƒ¼ â”€â”€ */
    #gameWrapper { position: relative; display: none; }

    canvas {
      display: block;
      image-rendering: pixelated;
      box-shadow: 0 0 40px #000a;
      border: 3px solid #333;
    }

    /* â”€â”€ HUD â”€â”€ */
    #hud {
      position: absolute;
      top: 0; left: 0; right: 0;
      display: flex;
      justify-content: space-between;
      padding: 8px 16px;
      background: var(--hud);
      color: #fff;
      font-size: 0.55rem;
      pointer-events: none;
    }

    #hud span { color: var(--accent); }

    /* â”€â”€ ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å…±é€š â”€â”€ */
    .overlay {
      position: absolute;
      inset: 0;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1.5rem;
      background: #000000bb;
      color: #fff;
    }

    .overlay.active { display: flex; }

    .overlay h2 {
      font-size: clamp(1rem, 3vw, 1.8rem);
      text-shadow: 3px 3px 0 #555;
    }

    .overlay h2.success { color: var(--accent); }
    .overlay h2.fail    { color: var(--danger); }

    .overlay button {
      background: transparent;
      border: 2px solid var(--accent);
      color: var(--accent);
      font-family: inherit;
      font-size: 0.6rem;
      padding: 0.8rem 1.8rem;
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
    }

    .overlay button:hover { background: var(--accent); color: #000; }

    /* â”€â”€ ãƒ¢ãƒã‚¤ãƒ«ãƒœã‚¿ãƒ³ â”€â”€ */
    #mobileControls {
      display: none;
      gap: 1rem;
      margin-top: 1rem;
    }

    @media (max-width: 768px), (pointer: coarse) {
      #mobileControls { display: flex; }
    }

    .mBtn {
      background: #ffffff22;
      border: 2px solid #ffffff44;
      color: #fff;
      font-family: inherit;
      font-size: 1.2rem;
      width: 64px; height: 64px;
      border-radius: 8px;
      cursor: pointer;
    }

    .mBtn:active { background: #ffffff44; }
  </style>
</head>
<body>

<!-- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
<div id="titleScreen">
  <h1>SUPER<br>PLATFORMER</h1>
  <div class="controls-hint">
    [W] / [SPACE] â”€â”€ ã‚¸ãƒ£ãƒ³ãƒ—<br>
    [A] å·¦ç§»å‹• &nbsp; [D] å³ç§»å‹•<br><br>
    å…¨5ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢ã›ã‚ˆï¼
  </div>
  <button id="startBtn">â–¶ START GAME</button>
</div>

<!-- ã‚²ãƒ¼ãƒ æœ¬ä½“ -->
<div id="gameWrapper">
  <div id="hud">
    <div>STAGE <span id="hudStage">1</span> / 5</div>
    <div>SCORE <span id="hudScore">0</span></div>
    <div>â¤ï¸ <span id="hudLives">3</span></div>
  </div>

  <canvas id="gameCanvas"></canvas>

  <div class="overlay" id="stageClear">
    <h2 class="success">âœ¨ STAGE CLEAR! âœ¨</h2>
    <p id="stageClearMsg" style="font-size:0.55rem;color:#aaa"></p>
    <button id="nextStageBtn">NEXT STAGE â–¶</button>
  </div>

  <div class="overlay" id="gameOver">
    <h2 class="fail">ğŸ’€ GAME OVER ğŸ’€</h2>
    <button id="retryBtn">RETRY</button>
    <button id="retryTitleBtn">TITLE</button>
  </div>

  <div class="overlay" id="gameClear">
    <h2 class="success">ğŸ† CONGRATULATIONS! ğŸ†</h2>
    <p style="font-size:0.55rem;color:#aaa">å…¨ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ï¼</p>
    <p id="finalScore" style="font-size:0.6rem;color:var(--accent)"></p>
    <button id="clearTitleBtn">TITLE ã¸æˆ»ã‚‹</button>
  </div>
</div>

<!-- ãƒ¢ãƒã‚¤ãƒ«æ“ä½œ -->
<div id="mobileControls">
  <button class="mBtn" id="btnLeft">â—€</button>
  <button class="mBtn" id="btnJump">â–²</button>
  <button class="mBtn" id="btnRight">â–¶</button>
</div>

<script>
// â”€â”€ ã‚­ãƒ£ãƒ³ãƒã‚¹åˆæœŸåŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const canvas = document.getElementById('gameCanvas');
const ctx    = canvas.getContext('2d');
const W = 800, H = 450;
canvas.width = W; canvas.height = H;

// â”€â”€ å®šæ•° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GRAVITY    = 0.55;
const JUMP_POWER = -13;
const MOVE_SPD   = 4.5;

// â”€â”€ ã‚²ãƒ¼ãƒ çŠ¶æ…‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let state = { stage: 1, score: 0, lives: 3, running: false };

// â”€â”€ å…¥åŠ›ç®¡ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const keys        = {};
const mobileState = { left: false, right: false, jump: false };

document.addEventListener('keydown', e => {
  keys[e.code] = true;
  if (['Space','ArrowUp','ArrowDown'].includes(e.code)) e.preventDefault();
});
document.addEventListener('keyup', e => { keys[e.code] = false; });

function bindMobile(id, prop) {
  const btn = document.getElementById(id);
  if (!btn) return;
  btn.addEventListener('pointerdown', () => { mobileState[prop] = true; });
  btn.addEventListener('pointerup',   () => { mobileState[prop] = false; });
  btn.addEventListener('pointerleave',() => { mobileState[prop] = false; });
}

const isLeft  = () => keys['KeyA'] || keys['ArrowLeft']  || mobileState.left;
const isRight = () => keys['KeyD'] || keys['ArrowRight'] || mobileState.right;
const isJump  = () => keys['KeyW'] || keys['Space'] || keys['ArrowUp'] || mobileState.jump;

// â”€â”€ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildStages() {
  return [
    // ã‚¹ãƒ†ãƒ¼ã‚¸1ï¼šæ˜“ã—ã„
    {
      worldW: 3200, bgColor: ['#5c94fc','#92c3ff'],
      playerStart: { x: 80, y: 300 },
      grounds: [
        { x: 0,    y: 380, w: 800  },
        { x: 850,  y: 380, w: 600  },
        { x: 1500, y: 380, w: 700  },
        { x: 2250, y: 380, w: 950  },
      ],
      platforms: [
        { x: 300, y: 300, w: 128 }, { x: 550, y: 240, w: 96  },
        { x: 900, y: 310, w: 128 }, { x: 1200,y: 270, w: 96  },
        { x: 1600,y: 300, w: 128 }, { x: 1900,y: 240, w: 96  },
      ],
      enemies: [
        { x: 400,  dir: 1  }, { x: 900,  dir: -1 },
        { x: 1600, dir: 1  }, { x: 2100, dir: -1 },
      ],
      goalX: 3050,
    },
    // ã‚¹ãƒ†ãƒ¼ã‚¸2ï¼šç©´å¢—ãˆã‚‹
    {
      worldW: 3600, bgColor: ['#6a5acd','#9370db'],
      playerStart: { x: 80, y: 300 },
      grounds: [
        { x: 0,    y: 380, w: 700 }, { x: 800,  y: 380, w: 500 },
        { x: 1500, y: 380, w: 400 }, { x: 2100, y: 380, w: 500 },
        { x: 2800, y: 380, w: 800 },
      ],
      platforms: [
        { x: 250,  y: 290, w: 128 }, { x: 450,  y: 220, w: 96  },
        { x: 850,  y: 300, w: 96  }, { x: 1050, y: 240, w: 128 },
        { x: 1550, y: 310, w: 96  }, { x: 1750, y: 240, w: 96  },
        { x: 2200, y: 300, w: 128 }, { x: 2500, y: 230, w: 96  },
      ],
      enemies: [
        { x: 300,  dir: 1  }, { x: 600,  dir: -1 }, { x: 1000, dir: 1  },
        { x: 1600, dir: -1 }, { x: 2200, dir: 1  }, { x: 2900, dir: -1 },
      ],
      goalX: 3450,
    },
    // ã‚¹ãƒ†ãƒ¼ã‚¸3ï¼šé«˜ä½å·®ãŒå¤§ãã„
    {
      worldW: 4000, bgColor: ['#1a1a3e','#2d1b69'],
      playerStart: { x: 80, y: 280 },
      grounds: [
        { x: 0,    y: 380, w: 500 }, { x: 600,  y: 380, w: 300 },
        { x: 1200, y: 380, w: 300 }, { x: 1700, y: 340, w: 300 },
        { x: 2200, y: 300, w: 300 }, { x: 2700, y: 380, w: 300 },
        { x: 3200, y: 380, w: 800 },
      ],
      platforms: [
        { x: 200,  y: 280, w: 128 }, { x: 400,  y: 210, w: 96  },
        { x: 650,  y: 300, w: 128 }, { x: 850,  y: 230, w: 96  },
        { x: 1000, y: 170, w: 96  }, { x: 1250, y: 310, w: 128 },
        { x: 1500, y: 240, w: 96  }, { x: 1750, y: 270, w: 96  },
        { x: 2050, y: 240, w: 128 }, { x: 2300, y: 220, w: 96  },
        { x: 2600, y: 300, w: 96  }, { x: 2900, y: 240, w: 128 },
      ],
      enemies: [
        { x: 300,  dir: 1  }, { x: 700,  dir: -1 }, { x: 1050, dir: 1  },
        { x: 1300, dir: -1 }, { x: 1800, dir: 1  }, { x: 2300, dir: -1 },
        { x: 2900, dir: 1  }, { x: 3300, dir: -1 },
      ],
      goalX: 3850,
    },
    // ã‚¹ãƒ†ãƒ¼ã‚¸4ï¼šæ•µãŒå¤šã„
    {
      worldW: 4200, bgColor: ['#2d4a00','#3d6b00'],
      playerStart: { x: 80, y: 300 },
      grounds: [
        { x: 0,    y: 380, w: 600 }, { x: 700,  y: 380, w: 400 },
        { x: 1300, y: 380, w: 500 }, { x: 2000, y: 380, w: 400 },
        { x: 2600, y: 380, w: 600 }, { x: 3400, y: 380, w: 800 },
      ],
      platforms: [
        { x: 200,  y: 290, w: 96  }, { x: 380,  y: 220, w: 128 },
        { x: 750,  y: 300, w: 96  }, { x: 950,  y: 240, w: 128 },
        { x: 1350, y: 290, w: 96  }, { x: 1550, y: 210, w: 96  },
        { x: 1750, y: 270, w: 128 }, { x: 2050, y: 300, w: 96  },
        { x: 2250, y: 230, w: 96  }, { x: 2650, y: 280, w: 128 },
        { x: 2900, y: 210, w: 96  }, { x: 3100, y: 260, w: 96  },
      ],
      enemies: [
        { x: 250,  dir: 1  }, { x: 450,  dir: -1 }, { x: 750,  dir: 1  },
        { x: 1000, dir: -1 }, { x: 1400, dir: 1  }, { x: 1650, dir: -1 },
        { x: 2050, dir: 1  }, { x: 2300, dir: -1 }, { x: 2700, dir: 1  },
        { x: 2950, dir: -1 }, { x: 3200, dir: 1  }, { x: 3500, dir: -1 },
      ],
      goalX: 4050,
    },
    // ã‚¹ãƒ†ãƒ¼ã‚¸5ï¼šæœ€çµ‚ãƒ»é«˜é›£åº¦
    {
      worldW: 5000, bgColor: ['#3d0000','#6b1010'],
      playerStart: { x: 80, y: 280 },
      grounds: [
        { x: 0,    y: 380, w: 400 }, { x: 500,  y: 380, w: 250 },
        { x: 900,  y: 350, w: 200 }, { x: 1250, y: 320, w: 200 },
        { x: 1600, y: 380, w: 300 }, { x: 2050, y: 380, w: 250 },
        { x: 2450, y: 380, w: 300 }, { x: 2900, y: 380, w: 250 },
        { x: 3300, y: 380, w: 300 }, { x: 3750, y: 380, w: 250 },
        { x: 4150, y: 380, w: 850 },
      ],
      platforms: [
        { x: 150,  y: 270, w: 96  }, { x: 320,  y: 200, w: 96  },
        { x: 550,  y: 310, w: 96  }, { x: 720,  y: 240, w: 128 },
        { x: 950,  y: 280, w: 96  }, { x: 1100, y: 210, w: 96  },
        { x: 1300, y: 250, w: 96  }, { x: 1480, y: 180, w: 96  },
        { x: 1650, y: 290, w: 96  }, { x: 1850, y: 220, w: 128 },
        { x: 2100, y: 280, w: 96  }, { x: 2300, y: 210, w: 96  },
        { x: 2500, y: 260, w: 128 }, { x: 2750, y: 190, w: 96  },
        { x: 2950, y: 270, w: 96  }, { x: 3150, y: 210, w: 96  },
        { x: 3400, y: 280, w: 128 }, { x: 3650, y: 220, w: 96  },
        { x: 3850, y: 270, w: 96  }, { x: 4050, y: 210, w: 96  },
      ],
      enemies: [
        { x: 200,  dir: 1  }, { x: 380,  dir: -1 }, { x: 550,  dir: 1  },
        { x: 750,  dir: -1 }, { x: 950,  dir: 1  }, { x: 1150, dir: -1 },
        { x: 1350, dir: 1  }, { x: 1550, dir: -1 }, { x: 1800, dir: 1  },
        { x: 2050, dir: -1 }, { x: 2250, dir: 1  }, { x: 2500, dir: -1 },
        { x: 2750, dir: 1  }, { x: 3000, dir: -1 }, { x: 3300, dir: 1  },
        { x: 3550, dir: -1 }, { x: 3800, dir: 1  }, { x: 4100, dir: -1 },
      ],
      goalX: 4850,
    },
  ];
}

// â”€â”€ ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£åŸºåº•ã‚¯ãƒ©ã‚¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class Entity {
  constructor(x, y, w, h) {
    this.x = x; this.y = y; this.w = w; this.h = h;
    this.vx = 0; this.vy = 0;
    this.onGround = false;
    this.alive = true;
  }

  collidesWith(other) {
    return this.x < other.x + other.w && this.x + this.w > other.x &&
           this.y < other.y + other.h && this.y + this.h > other.y;
  }
}

// â”€â”€ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class Player extends Entity {
  constructor(x, y) {
    super(x, y, 28, 36);
    this.jumpPressed = false;
    this.invincible  = 0;
    this.animFrame   = 0;
    this.animTimer   = 0;
    this.facing      = 1;
  }

  update(platforms, enemies, goal, worldW) {
    // ç§»å‹•å…¥åŠ›
    if (isLeft())       { this.vx = -MOVE_SPD; this.facing = -1; }
    else if (isRight()) { this.vx =  MOVE_SPD; this.facing =  1; }
    else                  this.vx = 0;

    // ã‚¸ãƒ£ãƒ³ãƒ—ï¼ˆæ¥åœ°æ™‚ã®ã¿ï¼‰
    const jumpNow = isJump();
    if (jumpNow && !this.jumpPressed && this.onGround) this.vy = JUMP_POWER;
    this.jumpPressed = jumpNow;

    // ç‰©ç†é©ç”¨
    this.vy += GRAVITY;
    this.x  += this.vx;
    this.y  += this.vy;

    // æ¨ªå£ã‚¯ãƒ©ãƒ³ãƒ—
    this.x = Math.max(0, Math.min(this.x, worldW - this.w));

    // åœ°å½¢è¡çªè§£æ±º
    this.onGround = false;
    for (const p of platforms) this._resolve(p);

    // è½ä¸‹æ­»
    if (this.y > H + 100) return 'fall';

    // ç„¡æ•µã‚¿ã‚¤ãƒãƒ¼
    if (this.invincible > 0) this.invincible--;

    // æ•µã¨ã®è¡çª
    if (this.invincible === 0) {
      for (const e of enemies) {
        if (!e.alive || !this.collidesWith(e)) continue;
        if (this.vy > 0 && this.y + this.h <= e.y + e.h * 0.55) {
          // è¸ã¿æ½°ã—
          e.alive = false;
          this.vy = -9;
          state.score += 100;
        } else {
          return 'hit';
        }
      }
    }

    // ã‚´ãƒ¼ãƒ«åˆ¤å®š
    if (this.collidesWith({ x: goal.x, y: goal.y, w: 32, h: 80 })) return 'goal';

    // æ­©ãã‚¢ãƒ‹ãƒ¡
    if (this.vx !== 0) {
      if (++this.animTimer >= 8) { this.animFrame ^= 1; this.animTimer = 0; }
    } else { this.animFrame = 0; }

    return null;
  }

  _resolve(p) {
    if (!this.collidesWith(p)) return;
    const ox = Math.min(this.x + this.w, p.x + p.w) - Math.max(this.x, p.x);
    const oy = Math.min(this.y + this.h, p.y + p.h) - Math.max(this.y, p.y);
    if (ox < oy) {
      this.x += this.x < p.x ? -ox : ox;
      this.vx = 0;
    } else {
      if (this.y < p.y) { this.y = p.y - this.h; this.vy = 0; this.onGround = true; }
      else               { this.y = p.y + p.h;   this.vy = 0; }
    }
  }

  draw(cx, camX) {
    if (this.invincible > 0 && Math.floor(this.invincible / 4) % 2) return;
    const sx = this.x - camX, sy = this.y;
    cx.save();
    cx.translate(sx + this.w / 2, sy + this.h / 2);
    if (this.facing === -1) cx.scale(-1, 1);

    // ãƒœãƒ‡ã‚£
    cx.fillStyle = '#e03020';
    cx.fillRect(-12, -10, 24, 20);
    // è„šï¼ˆã‚¢ãƒ‹ãƒ¡ï¼‰
    cx.fillStyle = '#4040c0';
    if (this.animFrame === 0) {
      cx.fillRect(-10, 10, 9, 10); cx.fillRect(1, 10, 9, 10);
    } else {
      cx.fillRect(-10, 8, 9, 12);  cx.fillRect(1, 12, 9, 8);
    }
    // é¡”
    cx.fillStyle = '#f0c090'; cx.fillRect(-8, -14, 16, 14);
    // å¸½å­
    cx.fillStyle = '#e03020';
    cx.fillRect(-10, -22, 20, 8); cx.fillRect(-6, -28, 14, 8);
    // ç›®
    cx.fillStyle = '#000'; cx.fillRect(2, -12, 4, 4);
    cx.restore();
  }
}

// â”€â”€ æ•µ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class Enemy extends Entity {
  constructor(x, y, dir) {
    super(x, y, 28, 28);
    this.vx        = dir * 1.8;
    this.walkTimer = 0;
    this.walkFrame = 0;
    this.deadTimer = 0;
  }

  update(platforms) {
    if (!this.alive) { this.deadTimer++; return; }

    this.vy += GRAVITY;
    this.x  += this.vx;
    this.y  += this.vy;

    let onG = false;
    for (const p of platforms) {
      if (!this.collidesWith(p)) continue;
      const ox = Math.min(this.x + this.w, p.x + p.w) - Math.max(this.x, p.x);
      const oy = Math.min(this.y + this.h, p.y + p.h) - Math.max(this.y, p.y);
      if (ox < oy) {
        this.vx *= -1;
        this.x  += this.x < p.x ? -ox : ox;
      } else if (this.y < p.y) {
        this.y = p.y - this.h; this.vy = 0; onG = true;
      }
    }

    // å´–ã§Uã‚¿ãƒ¼ãƒ³
    if (onG) {
      let edgeL = false, edgeR = false;
      for (const p of platforms) {
        const py2 = p.y + p.h;
        if (this.y + this.h >= p.y && this.y + this.h <= py2) {
          if (this.x - 4 >= p.x && this.x - 4 <= p.x + p.w)         edgeL = true;
          if (this.x + this.w + 4 >= p.x && this.x + this.w + 4 <= p.x + p.w) edgeR = true;
        }
      }
      if (!edgeL && this.vx < 0) this.vx *= -1;
      if (!edgeR && this.vx > 0) this.vx *= -1;
    }

    if (++this.walkTimer >= 10) { this.walkFrame ^= 1; this.walkTimer = 0; }
  }

  draw(cx, camX) {
    if (!this.alive && this.deadTimer > 20) return;
    const sx = this.x - camX, sy = this.y;
    if (!this.alive) {
      cx.fillStyle = '#808000'; cx.fillRect(sx, sy + this.h - 8, this.w, 8); return;
    }
    cx.save();
    cx.translate(sx + this.w / 2, sy + this.h / 2);
    // å‚˜ï¼ˆã‚­ãƒã‚³é¢¨ï¼‰
    cx.fillStyle = '#c0392b';
    cx.beginPath(); cx.arc(0, -4, 12, Math.PI, 0); cx.fill();
    cx.fillRect(-12, -4, 24, 12);
    // æ°´ç‰
    cx.fillStyle = '#ffffff88';
    cx.beginPath(); cx.arc(-5, -8, 3, 0, Math.PI * 2); cx.fill();
    cx.beginPath(); cx.arc( 5, -8, 3, 0, Math.PI * 2); cx.fill();
    // é¡”
    cx.fillStyle = '#f0c090'; cx.fillRect(-10, -4, 20, 14);
    // ç›®ï¼ˆæ­©ãã‚¢ãƒ‹ãƒ¡ï¼‰
    const ey = this.walkFrame ? -1 : 0;
    cx.fillStyle = '#000';
    cx.fillRect(-6, ey, 4, 4); cx.fillRect(2, ey, 4, 4);
    cx.restore();
  }
}

// â”€â”€ ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let particles = [];

function spawnParticles(x, y) {
  for (let i = 0; i < 8; i++) {
    particles.push({
      x, y,
      vx: (Math.random() - 0.5) * 6,
      vy: -Math.random() * 5 - 2,
      life: 30,
      color: `hsl(${Math.random() * 60 + 30},100%,60%)`,
    });
  }
}

function updateParticles() {
  for (const p of particles) { p.x += p.vx; p.y += p.vy; p.vy += 0.3; p.life--; }
  particles = particles.filter(p => p.life > 0);
}

function drawParticles(camX) {
  for (const p of particles) {
    ctx.save();
    ctx.globalAlpha = p.life / 30;
    ctx.fillStyle   = p.color;
    ctx.fillRect(p.x - camX - 3, p.y - 3, 6, 6);
    ctx.restore();
  }
}

// â”€â”€ ã‚²ãƒ¼ãƒ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let player, allPlatforms, enemies, goal, camX, currentStageData, animId;

// â”€â”€ ã‚¹ãƒ†ãƒ¼ã‚¸èª­ã¿è¾¼ã¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadStage(index) {
  const stages = buildStages();
  if (index >= stages.length) { showGameClear(); return; }

  currentStageData = stages[index];
  particles        = [];

  allPlatforms = [
    ...currentStageData.grounds.map(g => ({
      x: g.x, y: g.y, w: g.w, h: H - g.y, isGround: true,
    })),
    ...currentStageData.platforms.map(p => ({
      x: p.x, y: p.y, w: p.w, h: 16, isGround: false,
    })),
  ];

  // æ•µã®åˆæœŸYåº§æ¨™ã‚’åœ°å½¢ã«åˆã‚ã›ã¦è£œæ­£
  enemies = currentStageData.enemies.map(e => {
    let bestY = currentStageData.grounds[0]?.y ?? 380;
    for (const p of allPlatforms) {
      if (e.x >= p.x && e.x <= p.x + p.w && p.y > bestY - 100) {
        bestY = Math.min(bestY, p.y);
      }
    }
    return new Enemy(e.x, bestY - 28, e.dir);
  });

  // ã‚´ãƒ¼ãƒ«ä½ç½®ã®åœ°é¢ã‚’æ¢ã™
  const goalGround = currentStageData.grounds.find(g =>
    currentStageData.goalX >= g.x && currentStageData.goalX <= g.x + g.w
  );
  goal = { x: currentStageData.goalX, y: (goalGround?.y ?? 300) - 80 };

  player = new Player(currentStageData.playerStart.x, currentStageData.playerStart.y);
  camX   = 0;
  updateHUD();
}

// â”€â”€ æç”» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawBackground() {
  const [c1, c2] = currentStageData.bgColor;
  const grad = ctx.createLinearGradient(0, 0, 0, H);
  grad.addColorStop(0, c1); grad.addColorStop(1, c2);
  ctx.fillStyle = grad; ctx.fillRect(0, 0, W, H);

  // é æ™¯ãƒ‘ãƒ©ãƒ©ãƒƒã‚¯ã‚¹å±±
  ctx.fillStyle = '#00000022';
  const ox = -(camX * 0.15) % W;
  for (let i = -1; i < 3; i++) {
    const bx = ox + i * W;
    ctx.beginPath();
    ctx.moveTo(bx, H);
    ctx.lineTo(bx + 100, 250); ctx.lineTo(bx + 200, 300);
    ctx.lineTo(bx + 350, 200); ctx.lineTo(bx + 500, 280);
    ctx.lineTo(bx + 650, 220); ctx.lineTo(bx + W, H);
    ctx.fill();
  }

  // é›²
  ctx.fillStyle = '#ffffff18';
  const cloud = (x, y, r) => {
    ctx.beginPath();
    ctx.arc(x, y, r, 0, Math.PI * 2);
    ctx.arc(x + r * 0.8, y - r * 0.3, r * 0.7, 0, Math.PI * 2);
    ctx.arc(x + r * 1.5, y, r * 0.8, 0, Math.PI * 2);
    ctx.fill();
  };
  const co = -(camX * 0.3) % 600;
  for (let i = -1; i < 4; i++) {
    cloud(co + i * 600 + 50, 80, 40); cloud(co + i * 600 + 300, 60, 30);
  }
}

function drawPlatforms() {
  for (const p of allPlatforms) {
    const sx = p.x - camX;
    if (sx + p.w < 0 || sx > W) continue;
    if (p.isGround) {
      ctx.fillStyle = '#5a3010'; ctx.fillRect(sx, p.y, p.w, H - p.y);
      ctx.fillStyle = '#4a9020'; ctx.fillRect(sx, p.y, p.w, 12);
      ctx.fillStyle = '#3a7010';
      for (let i = 0; i < p.w; i += 32) ctx.fillRect(sx + i, p.y + 12, 16, 4);
    } else {
      ctx.fillStyle = '#c08020'; ctx.fillRect(sx, p.y, p.w, 16);
      ctx.fillStyle = '#e0a030'; ctx.fillRect(sx, p.y, p.w, 6);
      ctx.fillStyle = '#a06010'; ctx.fillRect(sx, p.y + 12, p.w, 4);
      ctx.strokeStyle = '#80400888'; ctx.lineWidth = 1;
      for (let i = 0; i < p.w; i += 16) ctx.strokeRect(sx + i, p.y, 16, 16);
    }
  }
}

function drawGoal() {
  const sx = goal.x - camX;
  if (sx < -50 || sx > W + 50) return;
  ctx.fillStyle = '#888'; ctx.fillRect(sx + 14, goal.y, 4, 80);
  ctx.fillStyle = '#ff4400';
  ctx.beginPath(); ctx.moveTo(sx + 18, goal.y);
  ctx.lineTo(sx + 42, goal.y + 12); ctx.lineTo(sx + 18, goal.y + 24); ctx.fill();
  ctx.fillStyle = '#555'; ctx.fillRect(sx + 10, goal.y + 72, 12, 8);
  ctx.fillStyle = '#ffd700'; ctx.font = 'bold 11px monospace';
  ctx.textAlign = 'center'; ctx.fillText('GOAL', sx + 16, goal.y - 6);
  ctx.textAlign = 'left';
}

// â”€â”€ ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gameLoop() {
  if (!state.running) return;

  const result = player.update(allPlatforms, enemies, goal, currentStageData.worldW);

  for (const e of enemies) {
    const wasAlive = e.alive;
    e.update(allPlatforms);
    if (wasAlive && !e.alive) spawnParticles(e.x + e.w / 2, e.y);
  }
  updateParticles();

  // ã‚«ãƒ¡ãƒ©è¿½å¾“
  camX = Math.max(0, Math.min(player.x - W / 3, currentStageData.worldW - W));

  // å‰é€²ã‚¹ã‚³ã‚¢
  state.score = Math.max(state.score, Math.floor(player.x / 10) * 10 + (state.stage - 1) * 5000);
  updateHUD();

  // æç”»
  drawBackground();
  drawPlatforms();
  drawGoal();
  drawParticles(camX);
  for (const e of enemies) e.draw(ctx, camX);
  player.draw(ctx, camX);

  // çµæœå‡¦ç†
  if (result === 'goal') {
    state.running = false;
    state.stage >= 5 ? showGameClear() : showStageClear();
    return;
  }
  if (result === 'fall' || result === 'hit') {
    state.lives--;
    updateHUD();
    if (state.lives <= 0) { state.running = false; showGameOver(); return; }
    // ãƒ’ãƒƒãƒˆï¼šãã®å ´ãƒªã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆç„¡æ•µä»˜ãï¼‰/ è½ä¸‹ï¼šã‚¹ãƒ†ãƒ¼ã‚¸å…ˆé ­ã‹ã‚‰
    if (result === 'hit') {
      player.x = currentStageData.playerStart.x;
      player.y = currentStageData.playerStart.y;
      player.vx = 0; player.vy = 0;
    } else {
      loadStage(state.stage - 1);
    }
    player.invincible = 120;
  }

  animId = requestAnimationFrame(gameLoop);
}

// â”€â”€ HUD / ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤åˆ¶å¾¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateHUD() {
  document.getElementById('hudStage').textContent = state.stage;
  document.getElementById('hudScore').textContent = state.score.toLocaleString();
  document.getElementById('hudLives').textContent = state.lives;
}

function showOverlay(id) {
  ['stageClear','gameOver','gameClear'].forEach(n =>
    document.getElementById(n).classList.remove('active')
  );
  if (id) document.getElementById(id).classList.add('active');
}

function showStageClear() {
  document.getElementById('stageClearMsg').textContent =
    `ã‚¹ãƒ†ãƒ¼ã‚¸ ${state.stage} ã‚¯ãƒªã‚¢ï¼  SCORE: ${state.score.toLocaleString()}`;
  showOverlay('stageClear');
}

function showGameOver()  { showOverlay('gameOver'); }

function showGameClear() {
  document.getElementById('finalScore').textContent =
    `FINAL SCORE: ${state.score.toLocaleString()}`;
  showOverlay('gameClear');
}

// â”€â”€ ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆonclickå±æ€§ä¸è¦ãƒ»JSå†…ã§ãƒã‚¤ãƒ³ãƒ‰ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  // ãƒ¢ãƒã‚¤ãƒ«ãƒœã‚¿ãƒ³
  bindMobile('btnLeft',  'left');
  bindMobile('btnRight', 'right');
  bindMobile('btnJump',  'jump');

  // ã‚¹ã‚¿ãƒ¼ãƒˆ
  document.getElementById('startBtn').addEventListener('click', () => {
    document.getElementById('titleScreen').style.display = 'none';
    document.getElementById('gameWrapper').style.display = 'block';
    state = { stage: 1, score: 0, lives: 3, running: true };
    loadStage(0);
    if (animId) cancelAnimationFrame(animId);
    animId = requestAnimationFrame(gameLoop);
  });

  // ãƒã‚¯ã‚¹ãƒˆã‚¹ãƒ†ãƒ¼ã‚¸
  document.getElementById('nextStageBtn').addEventListener('click', () => {
    state.stage++;
    showOverlay(null);
    loadStage(state.stage - 1);
    state.running = true;
    if (animId) cancelAnimationFrame(animId);
    animId = requestAnimationFrame(gameLoop);
  });

  // ãƒªãƒˆãƒ©ã‚¤
  document.getElementById('retryBtn').addEventListener('click', () => {
    state = { stage: 1, score: 0, lives: 3, running: true };
    showOverlay(null);
    loadStage(0);
    if (animId) cancelAnimationFrame(animId);
    animId = requestAnimationFrame(gameLoop);
  });

  // ã‚¿ã‚¤ãƒˆãƒ«ã¸ï¼ˆã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼‰
  document.getElementById('retryTitleBtn').addEventListener('click', returnTitle);
  // ã‚¿ã‚¤ãƒˆãƒ«ã¸ï¼ˆã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼‰
  document.getElementById('clearTitleBtn').addEventListener('click', returnTitle);
});

function returnTitle() {
  state.running = false;
  if (animId) cancelAnimationFrame(animId);
  showOverlay(null);
  document.getElementById('gameWrapper').style.display  = 'none';
  document.getElementById('titleScreen').style.display  = 'flex';
}
</script>
</body>
</html>
